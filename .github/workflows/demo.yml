name: hello-world

on: push

jobs:

  ubuntu:
    name: Ubuntu MPI Run
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Say Hello
        run: echo "Hello from Ubuntu!"

      - name: Install OpenMPI (Ubuntu)
        run: |
          sudo apt-get update
          sudo apt-get install -y openmpi-bin libopenmpi-dev
          which mpirun
          which mpicc
          lscpu
          free -h
          df -h

      - name: Compile MPI program
        run: mpicxx t1.cpp -o t_mpi

      - name: Run MPI program
        run: |
          mpirun --report-pid --display-devel-map -np 1 ./t_mpi
          mpirun --oversubscribe --report-pid --display-devel-map -np 4 hostname

  rocky:
    name: Rocky Linux MPI Run
    runs-on: ubuntu-latest   # GitHub runner host
    container:
      image: rockylinux:9    # Rocky runs inside the container
      options: --privileged

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Say Hello
        run: echo "Hello from Rocky Linux!"

      - name: Install OpenMPI (Rocky)
        run: |
          dnf install -y epel-release
          dnf install -y openmpi openmpi-devel which

          # Add OpenMPI paths so future steps can find mpicxx/mpirun
          echo "/usr/lib64/openmpi/bin" >> $GITHUB_PATH
          echo "/usr/lib64/openmpi/lib" >> $GITHUB_PATH
          echo "LD_LIBRARY_PATH=/usr/lib64/openmpi/lib" >> $GITHUB_ENV

      - name: Verify MPI executables
        run: |
          which mpirun
          which mpicxx
          mpirun --version
          mpicxx --version

      - name: Compile MPI program
        run: mpicxx t1.cpp -o t_mpi

      - name: Run MPI program
        run: |
          mpirun -np 4 ./t_mpi
          mpirun --use-hwthread-cpus -np 4 ./t_mpi
          mpirun --report-pid --display-devel-map -np 1 hostname
          mpirun --report-pid --display-devel-map -np 1 ./t_mpi
          mpirun --oversubscribe --report-pid --display-devel-map -np 4 hostname
